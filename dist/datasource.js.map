{"version":3,"sources":["../src/datasource.js"],"names":["metricDivider","urlValidationRegex","getContext","target","context","siteopt","site","host_tags","usehostregex","hostregex","host_regex","host","serviceregex","service_regex","CheckmkDatasource","instanceSettings","backendSrv","templateSrv","type","name","rawUrl","jsonData","url","_username","username","_secret","secret","headers","lastErrors","scopedVars","range","combinedgraph","service","metric","graph","Promise","resolve","data","host_name","replace","service_description","graph_index","metric_index","mode","queryCombinedTarget","split","map","i","isNaN","specification","data_range","time_range","from","unix","to","refId","doRequest","params","action","then","response","result_code","Error","result","start_time","step","curves","format","catch","err","message","graph_template","presentation","single_infos","datasource","options","targets","filter","hide","all","queryTarget","reduce","d","concat","test","ERROR","FORMAT","status","STATUS","OTHER","title","cancelled","CANCEL","READ","annotation","queries","query","useserviceregex","end_time","availability_timelines","length","items","tl","timeline","state","showAnnotations","includes","item","Object","assign","a","baseLink","hostLink","view_name","serviceLink","stateLink","av_mode","tableData","in_downtime","text","tr","td","join","time","hostsQuery","disableAll","getResult","value","sort","sortByText","sites","site_id","hostname","keys","key","services","tag_groups","id","index","find","tags","serviceOptionsQuery","graphIndex","metrics","metricIndex","f","findIndex","x","identification","output_format","method","datasourceRequest"],"mappings":"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","file":"datasource.js","sourcesContent":["import ERROR from './utils/errors';\nimport {buildUrlWithParams, buildRequestBody, getResult} from './utils/request';\nimport {sortByText} from './utils/sort';\nimport {formatCurveData, getHostTags} from './utils/data';\nimport { getTemplateSrv } from '@grafana/runtime';\n\n/*\n * Grafana requires these methods:\n *\n * query(options)           // used by panels to get data\n * testDatasource()         // used by datasource configuration page to make sure the connection is working\n * metricFindQuery(options) // used by query editor to get metric suggestions.\n * annotationQuery(options) // used by dashboards to get annotations (optional)\n */\n\n \nconst metricDivider = '.';\nconst urlValidationRegex = /^https?:\\/\\/[^/]*\\/[^/]*\\/$/;\n\nconst getContext = (target) => {\n    const context = {\n        siteopt: {site: target.site},\n        host_tags: getHostTags(target)\n    };\n\n    if(target.usehostregex && target.hostregex) {\n        context.hostregex = {host_regex: target.hostregex};\n    }\n\n    if(!target.usehostregex && target.host) {\n        context.host = {host: target.host};\n    }\n\n    if(target.serviceregex) {\n        context.serviceregex = {service_regex: target.serviceregex};\n    }\n\n    return context;\n};\n\nexport class CheckmkDatasource {\n    // backendSrv, templateSrv are injected - do not rename\n    constructor(instanceSettings, backendSrv, templateSrv) {\n        this.type = instanceSettings.type;\n        this.name = instanceSettings.name;\n        this.backendSrv = backendSrv;\n        this.templateSrv = templateSrv;\n\n        this.rawUrl = instanceSettings.jsonData.url;\n        this._username = instanceSettings.jsonData.username;\n        this._secret = instanceSettings.jsonData.secret;\n\n        this.headers = {'Content-Type': 'application/x-www-form-urlencoded'};\n\n        this.lastErrors = {};\n    }\n\n    queryTarget(target, {scopedVars,range}) {\n        if(!target || (target.combinedgraph === '' && (!target.host || !target.service || (target.metric === '' && target.graph === '')))) {\n            return Promise.resolve({data: []});\n        }\n\n        const site = target.site || null;\n        const host_name = getTemplateSrv().replace(target.host,scopedVars);\n\n        const service_description = target.service;\n\n        let graph_index;\n        let metric_index;\n\n        if(target.mode === 'combined') {\n            return this.queryCombinedTarget(target, {scopedVars,range});\n        } else if(target.mode === 'metric') {\n            [graph_index, metric_index] = target.metric.split(metricDivider).map((i) => +i);\n        } else {\n            graph_index = +target.graph;\n        }\n\n        if(isNaN(graph_index)) {\n            return Promise.resolve({data: []});\n        }\n\n        const data = buildRequestBody({\n            specification: [\n                'template',\n                {\n                    site,\n                    host_name,\n                    service_description,\n                    graph_index\n                }\n            ],\n            data_range: {\n                time_range: [\n                    range.from.unix(),\n                    range.to.unix()\n                ]\n            }\n        });\n\n        delete this.lastErrors[target.refId];\n\n        return this.doRequest({\n            params: {action: 'get_graph'},\n            data\n        })\n            .then((response) => {\n                if(response.data.result_code !== 0) {\n                    throw new Error(`${response.data.result}`);\n                }\n\n                const {start_time, step, curves} = response.data.result;\n                const format = formatCurveData(start_time, step, target.format, target);\n\n                if(metric_index != null) {\n                    // filter for one specific metric\n                    return [format(curves[metric_index])];\n                }\n\n                return curves.map(format);\n            })\n            .catch((err) => {\n                this.lastErrors[target.refId] = err.message;\n            });\n    }\n\n    queryCombinedTarget(target, {scopedVars,range}) {\n        let host_name = getTemplateSrv().replace(target.host,scopedVars);\n        target.host = host_name;\n\n        const data = {\n            specification: [\n                'combined',\n                {\n                    context: getContext(target),\n                    graph_template: target.combinedgraph,\n                    presentation: target.presentation,\n                    single_infos: ['host'],\n                    datasource: 'services'\n                }\n            ],\n            data_range: {\n                time_range: [\n                    range.from.unix(),\n                    range.to.unix()\n                ]\n            }\n        };\n\n        if(!target.usehostregex) {\n            data.specification[1].host_name = target.host;\n        }\n\n        delete this.lastErrors[target.refId];\n\n        return this.doRequest({\n            params: {action: 'get_graph'},\n            data: buildRequestBody(data)\n        })\n            .then((response) => {\n                if(response.data.result_code !== 0) {\n                    throw new Error(`${response.data.result}`);\n                }\n\n                const {start_time, step, curves} = response.data.result;\n                return curves.map(formatCurveData(start_time, step, target.format, target));\n            })\n            .catch((err) => {\n                this.lastErrors[target.refId] = err.message;\n            });\n    }\n\n    getLastError(refId) {\n        return this.lastErrors[refId];\n    }\n\n    query(options) {\n        const targets = options.targets.filter(({hide}) => !hide);\n        return Promise.all(targets.map((target) => this.queryTarget(target, options)))\n            .then((data) => data.reduce((all, d) => all.concat(d), []))\n            .then((data) => ({data}));\n    }\n\n    testDatasource() {\n        if(!urlValidationRegex.test(this.rawUrl)) {\n            return ERROR.FORMAT;\n        }\n\n        return this.doRequest({\n            params: {action: 'get_host_names'}\n        })\n            .then((response) => {\n                if(response.status !== 200) {\n                    return ERROR.STATUS;\n                } else if (!response.data.result) {\n                    return ERROR.OTHER(response.data);\n                } else {\n                    return {\n                        status: 'success',\n                        message: 'Data source is working',\n                        title: 'Success'\n                    };\n                }\n            })\n            .catch(({cancelled}) => cancelled ? ERROR.CANCEL : ERROR.READ);\n    }\n\n    annotationQuery(options) {\n        const [query] = options.annotation.queries;\n\n        const context = {\n            site: query.site,\n            serviceregex: {service_regex: query.useserviceregex ? query.serviceregex : query.service || '.*'}\n        };\n\n        if(query.usehostregex) {\n            context.hostregex = {host_regex: query.hostregex};\n        } else {\n            context.host = query.host;\n        }\n\n        const data = {\n            context,\n            start_time: options.range.from.unix(),\n            end_time: options.range.to.unix()\n        };\n\n        return this.doRequest({\n            params: {action: 'get_graph_annotations'},\n            data: buildRequestBody(data)\n        }).then((result) => {\n            if(!result.data.result.availability_timelines) {\n                throw new Error('Annotations are not supported by this Checkmk version.');\n            }\n            if(!result.data.result.availability_timelines.length) {\n                return [];\n            }\n\n            const items = result.data.result.availability_timelines\n                .map((tl) => tl.timeline\n                    .filter(([, state]) => query.showAnnotations.includes(state))\n                    .map(([item, state]) => Object.assign(item, {state}))\n                )\n                .reduce((all, a) => all.concat(a), []);\n\n            const baseLink = `${this.rawUrl}check_mk/view.py`;\n\n            return items.map((item) => {\n                const hostLink = buildUrlWithParams(baseLink, {\n                    host: item.host_name,\n                    site: item.site,\n                    view_name: 'hoststatus'\n                });\n                const serviceLink = buildUrlWithParams(baseLink, {\n                    host: item.host_name,\n                    site: item.site,\n                    service: item.service_description,\n                    view_name: 'service'\n                });\n                const stateLink = buildUrlWithParams(baseLink, {\n                    host: item.host_name,\n                    site: item.site,\n                    service: item.service_description,\n                    view_name: 'service',\n                    mode: 'availability',\n                    av_mode: 'timeline'\n                });\n                const tableData = [\n                    ['Host', `<a href=\"${hostLink}\" target=\"_blank\">${item.host_name}</a>`],\n                    ['Service Description', `<a href=\"${serviceLink}\" target=\"_blank\">${item.service_description}</a>`],\n                    ['State', `<a href=\"${stateLink}\" target=\"_blank\">${item.state}</a>`],\n                    ['In Downtime', item.in_downtime ? 'Yes' : 'No']\n                ];\n\n                const text = `<table>${\n                    tableData\n                        .map((tr) => tr.map((td) => `<td>&nbsp;${td}&nbsp;</td>`).join(''))\n                        .map((tr) => `<tr>${tr}</tr>`)\n                        .join('')\n                }</table>`;\n\n                return {\n                    annotation: options,\n                    time: item.from * 1000,\n                    text\n                };\n            });\n        });\n    }\n\n    metricFindQuery(query) {\n        if(query == 'host') {\n            return this.hostsQuery({site: ''});\n        }\n        \n        return [ { 'text' : query, 'value': query} ];\n    }\n\n    \n    sitesQuery(query, disableAll = false) {\n        return this.doRequest({\n            params: {action: 'get_user_sites'}\n        })\n            .then(getResult)\n            .then((result) => result\n                .map(([value, text]) => ({text, value}))\n                .sort(sortByText)\n            )\n            .then((sites) => disableAll ? sites : [{text: 'All Sites', value: ''}].concat(sites));\n    }\n\n    hostsQuery(query) {\n        const params = {\n            action: 'get_host_names'\n        };\n\n        if(query.site) {\n            params.site_id = query.site;\n        }\n\n        return this.doRequest({params})\n            .then(getResult)\n            .then((result) => result\n                .map((hostname) => ({text: hostname, value: hostname}))\n                .sort(sortByText)\n            );\n    }\n\n    servicesQuery(query, disableAll = false) {\n        if(!query.host) {\n            return Promise.resolve([]);\n        }\n        return this.doRequest({\n            params: {action: 'get_metrics_of_host'},\n            data: buildRequestBody({hostname: query.host})\n        })\n            .then(getResult)\n            .then((result) => Object.keys(result)\n                .map((key) => ({text: key, value: key}))\n                .sort(sortByText)\n            )\n            .then((services) => disableAll ? services : [{text: 'All Services', value: ''}].concat(services));\n    }\n\n    serviceOptionsQuery(query) {\n        const data = {\n            specification: [\n                'template',\n                {\n                    site: query.site || null,\n                    service_description: query.service,\n                    host_name: query.host\n                }\n            ]\n        };\n\n        return this.doRequest({\n            params: {action: 'get_graph_recipes'},\n            data: buildRequestBody(data)\n        });\n    }\n\n    filterGroupQuery() {\n        return this.doRequest({params: {action: 'get_hosttags'}})\n            .then(getResult)\n            .then((result) => result.tag_groups\n                .map(({id, title}) => ({text: title, value: id}))\n                .sort(sortByText)\n            );\n    }\n\n    filterValueQuery(query, index) {\n        if(!query[`filter${index}group`]) {\n            return Promise.resolve([]);\n        }\n        return this.doRequest({params: {action: 'get_hosttags'}})\n            .then(getResult)\n            .then((result) => result.tag_groups\n                .find(({id}) => id === query[`filter${index}group`]).tags\n                .map(({id, title}) => ({text: title, value: id}))\n                .sort(sortByText)\n            );\n    }\n\n    metricsQuery(query) {\n        if(!query.host || !query.service) {\n            return Promise.resolve([]);\n        }\n\n        return this.serviceOptionsQuery(query)\n            .then(getResult)\n            .then((result) => {\n                if(!result.length) {\n                    return [{text: 'no metrics available', value: '-'}];\n                }\n\n                return result\n                    .map((graph, graphIndex) => graph.metrics\n                        .map((metric, metricIndex) => ({text: metric.title, value: `${graphIndex}${metricDivider}${metricIndex}`}))\n                    )\n                    .reduce((all, metrics) => all.concat(metrics), [])\n                    .filter((f, i, all) => all.findIndex((x) => x.text === f.text) === i) // metrics are not necessary unique to one graph, filtering here to make results unique\n                    .sort(sortByText);\n            });\n    }\n\n    graphsQuery(query) {\n        if(!query.host || !query.service) {\n            return Promise.resolve([]);\n        }\n\n        return this.serviceOptionsQuery(query)\n            .then((response) => {\n                if(!response.data.result.length) {\n                    return [{text: 'no graphs available', value: '-'}];\n                }\n\n                return response.data.result\n                    .map((graph, index) => ({text: graph.title, value: index}))\n                    .sort(sortByText);\n            });\n    }\n\n    combinedGraphsQuery(query) {\n        if(!query.presentation) {\n            return Promise.resolve([]);\n        }\n\n        const data = {\n            context: getContext(query),\n            datasource: 'services',\n            presentation: query.presentation,\n            single_infos: ['host']\n        };\n\n        return this.doRequest({\n            params: {action: 'get_combined_graph_identifications'},\n            data: buildRequestBody(data)\n        })\n            .then((response) => {\n                if(!response.data.result.length) {\n                    return [{text: 'no graphs available', value: '-'}];\n                }\n\n                return response.data.result\n                    .map(({title, identification}) => ({text: title, value: identification[1].graph_template}))\n                    .sort(sortByText);\n            });\n    }\n\n    doRequest(options) {\n        options.url = buildUrlWithParams(`${this.rawUrl}check_mk/webapi.py`, Object.assign({\n            _username: this._username,\n            _secret: this._secret,\n            output_format: 'json',\n        }, options.params));\n\n        delete options.params;\n\n        options.method = options.data == null ? 'GET' : 'POST';\n        options.headers = this.headers;\n\n        return this.backendSrv.datasourceRequest(options);\n    }\n}\n"]}